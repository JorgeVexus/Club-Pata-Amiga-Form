<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentaci√≥n de Ingenier√≠a - Club Pata Amiga</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #15BEB2;
            --secondary: #febd01;
            --accent: #fe4b5b;
            --dark: #002346;
            --sidebar-bg: #001a35;
            --bg-light: #f4f7f9;
            --superadmin: #7C3AED;
            --code-bg: #0f172a;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            margin: 0;
            background: var(--bg-light);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 320px;
            background: var(--sidebar-bg);
            color: white;
            padding: 40px 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 1.2rem;
            margin-bottom: 30px;
            letter-spacing: 1px;
            color: var(--primary);
        }

        .nav-group {
            margin-bottom: 30px;
        }

        .nav-group-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .nav-link {
            display: block;
            padding: 10px 15px;
            color: #cbd5e1;
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }

        .nav-link.active {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        /* Main Content */
        .content {
            margin-left: 320px;
            flex: 1;
            padding: 60px 80px;
            max-width: 1100px;
        }

        /* Sections */
        section {
            margin-bottom: 100px;
            scroll-margin-top: 60px;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 10px;
        }

        h2 {
            font-size: 2rem;
            color: var(--dark);
            border-bottom: 4px solid var(--primary);
            display: inline-block;
            padding-bottom: 5px;
            margin-top: 40px;
            margin-bottom: 30px;
        }

        h3 {
            font-size: 1.4rem;
            color: var(--dark);
            margin-top: 40px;
        }

        p {
            line-height: 1.8;
            color: #475569;
            font-size: 1.05rem;
        }

        /* Feature Boxes */
        .info-box {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            margin: 30px 0;
            border-left: 6px solid var(--primary);
        }

        .warning-box {
            background: #fffafa;
            border-left: 6px solid var(--accent);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
        }

        /* Code & Tables */
        code {
            font-family: 'JetBrains Mono', monospace;
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        pre {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 25px;
            border-radius: 15px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.5;
            font-size: 0.85rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
        }

        th {
            background: var(--dark);
            color: white;
            padding: 18px;
            text-align: left;
        }

        td {
            padding: 18px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: top;
        }

        /* Badges */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-api {
            background: #e0f2fe;
            color: #0369a1;
        }

        .badge-db {
            background: #f0fdf4;
            color: #15803d;
        }

        .badge-super {
            background: var(--superadmin);
            color: white;
        }

        .debug-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 30px 0;
        }

        .debug-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 1px solid #e2e8f0;
        }

        .debug-card h4 {
            margin-top: 0;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                width: 250px;
            }

            .content {
                margin-left: 250px;
                padding: 40px;
            }
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <h2>CLUB PATA AMIGA</h2>
        <div class="nav-group">
            <div class="nav-group-title">GENERAL</div>
            <a href="#arquitectura" class="nav-link">Arquitectura T√©cnica</a>
            <a href="#registro" class="nav-link">Flujo de Registro</a>
        </div>
        <div class="nav-group">
            <div class="nav-group-title">M√ìDULOS</div>
            <a href="#embajadores" class="nav-link">Embajadores & Payouts</a>
            <a href="#apelaciones" class="nav-link">Hub de Apelaciones</a>
        </div>
        <div class="nav-group">
            <div class="nav-group-title">RECURSOS</div>
            <a href="#debugging" class="nav-link">Gu√≠a de Debugging</a>
            <a href="#qa" class="nav-link">Plan de QA Maestro</a>
            <a href="#api" class="nav-link">Referencia de API</a>
        </div>
    </aside>

    <main class="content">
        <header>
            <h1>Gu√≠a de Ingenier√≠a</h1>
            <p>Documentaci√≥n t√©cnica exhaustiva para el mantenimiento, despliegue y auditor√≠a del sistema de Embajadores
                y Apelaciones.</p>
        </header>

        <!-- ARQUITECTURA -->
        <section id="arquitectura">
            <h2>1. Arquitectura de Datos</h2>
            <p>El ecosistema utiliza una estructura h√≠brida para garantizar resiliencia y velocidad:</p>

            <div class="info-box">
                <h3>Puntos de Sincronizaci√≥n</h3>
                <ul>
                    <li><strong>Memberstack (Auth & Global):</strong> Almacena el estado de suscripci√≥n y metadatos
                        b√°sicos (Custom Fields).</li>
                    <li><strong>Supabase (Relacional & Operativo):</strong> Almacena mascotas, apelaciones, registros de
                        embajadores, sesiones de referidos y pagos.</li>
                    <li><strong>Relaci√≥n:</strong> Se utiliza el <code>memberstack_id</code> como llave for√°nea
                        principal en la tabla <code>users</code> de Supabase para vincular ambos mundos.</li>
                </ul>
            </div>

            <pre>// Estructura de la tabla 'ambassadors'
{
  id: "uuid",
  referral_code: "PATA-NAME-XXXX", // El que comparte el usuario
  ambassador_code: "EMB-2026-XXXX", // Uso interno / ID √∫nico
  status: "pending | approved | rejected",
  pending_payout: "numeric", // Saldo actual para retirar
  total_earnings: "numeric"  // Hist√≥rico total ganado
}</pre>
        </section>

        <!-- REGISTRO -->
        <section id="registro">
            <h2>2. Flujo de Registro de Embajador</h2>
            <p>El sistema maneja de forma inteligente si el aplicante es un perro nuevo en la manada o un miembro ya
                establecido.</p>

            <h3>Escenarios de Registro</h3>
            <table>
                <tr>
                    <th>Tipo</th>
                    <th>Acci√≥n del Sistema</th>
                    <th>Validaci√≥n Clave</th>
                </tr>
                <tr>
                    <td><strong>Usuario Nuevo</strong></td>
                    <td>Crea registro en Supabase y marca como 'pending'. Env√≠a documentos (INE/RFC) a bucket.</td>
                    <td>CURP √∫nico. Email √∫nico.</td>
                </tr>
                <tr>
                    <td><strong>Miembro Existente</strong></td>
                    <td>Hereda <code>memberstack_id</code> del usuario logueado. Permite "upgrade" r√°pido.</td>
                    <td>No permite registrarse dos veces con la misma cuenta de Memberstack.</td>
                </tr>
            </table>

            <div class="warning-box">
                <strong>Nota de Debugging:</strong> Si un usuario no puede registrarse y dice "Email ya registrado",
                verifica si existe en la tabla <code>ambassadors</code> de Supabase, incluso si nunca termin√≥ de llenar
                los documentos.
            </div>
        </section>

        <!-- EMBAJADORES Y PAYOUTS -->
        <section id="embajadores">
            <h2>3. Gesti√≥n de Comisiones y Pagos</h2>
            <p>El flujo econ√≥mico es el punto m√°s sensible y requiere una auditor√≠a estricta.</p>

            <h3>Ciclo de Vida de una Comisi√≥n</h3>
            <ol>
                <li><strong>Detecci√≥n:</strong> El script del widget detecta <code>?ref=ID</code>, guarda en
                    <code>localStorage</code> (duraci√≥n 30 d√≠as).</li>
                <li><strong>Registro:</strong> Al completar el form de membres√≠a, la API <code>/api/referrals</code>
                    detecta la cookie/storage y crea el registro como <code>pending</code>.</li>
                <li><strong>Aprobaci√≥n:</strong> El Admin revisa que el pago de la membres√≠a sea real y aprueba. En ese
                    momento se suma al <code>pending_payout</code> del embajador.</li>
                <li><strong>Retiro:</strong> El embajador solicita. El sistema resta el monto y crea el registro en
                    <code>ambassador_payouts</code>.</li>
            </ol>

            <pre>POST /api/ambassadors/[id]/payouts
// Payload: Vac√≠o (el sistema calcula el saldo disponible autom√°ticamente)
// Respuesta: { success: true, payout_id: "...", new_balance: 0 }</pre>
        </section>

        <!-- HUB DE APELACIONES -->
        <section id="apelaciones">
            <h2>4. Hub de Apelaciones (SuperAdmin)</h2>
            <p>Garant√≠a de calidad para documentos de mascotas con acceso restringido.</p>

            <div class="info-box" style="border-left-color: var(--superadmin);">
                <p><span class="status-badge badge-super">RESTRICCI√ìN</span> Las apelaciones requieren criterio humano
                    de alto nivel. Solo usuarios con <code>role: super_admin</code> en Supabase pueden acceder.</p>
            </div>

            <h3>Estados de la Mascota</h3>
            <ul>
                <li><code>pending</code>: Esperando revisi√≥n inicial.</li>
                <li><code>rejected | action_required</code>: Admin encontr√≥ error (activa bot√≥n de Apelar en usuario).
                </li>
                <li><code>appealed</code>: Usuario envi√≥ mensaje de defensa. El miembro cambia globalmente a estado
                    <code>appealed</code> en Memberstack.</li>
                <li><code>approved</code>: Fin del ciclo.</li>
            </ul>
        </section>

        <!-- DEBUGGING -->
        <section id="debugging">
            <h2>5. Gu√≠a de Debugging y Soluci√≥n de Problemas</h2>
            <p>Manual para resolver los incidentes m√°s probables en producci√≥n.</p>

            <div class="debug-grid">
                <div class="debug-card">
                    <h4>üîç El referido no aparece</h4>
                    <p><strong>Causa:</strong> El usuario bloque√≥ cookies o cambi√≥ de navegador entre el clic y el
                        registro.</p>
                    <p><strong>Soluci√≥n:</strong> Verificar en el panel de Admin si el registro de membres√≠a tiene el
                        campo <code>referral_code</code> lleno. Si no, se puede asignar manualmente desde Supabase
                        editando el registro en la tabla <code>referrals</code>.</p>
                </div>
                <div class="debug-card">
                    <h4>üõ†Ô∏è Bot√≥n de Retiro no funciona</h4>
                    <p><strong>Causa:</strong> Saldo insuficiente o solicitud pendiente previa.</p>
                    <p><strong>Soluci√≥n:</strong> El bot√≥n se deshabilita si <code>pending_payout <= 0</code>. Revisa en
                        la DB si el embajador tiene saldos negativos o solicitudes en estado <code>processing</code>.
                    </p>
                </div>
                <div class="debug-card">
                    <h4>üîë No veo el men√∫ de Apelaciones</h4>
                    <p><strong>Causa:</strong> Tu rol en la tabla <code>users</code> de Supabase es <code>admin</code> y
                        no <code>super_admin</code>.</p>
                    <p><strong>Soluci√≥n:</strong> Un Master Admin debe cambiar tu rol directamente en la tabla de
                        Supabase tabla de usuarios.</p>
                </div>
                <div class="debug-card">
                    <h4>üìß No llegan correos</h4>
                    <p><strong>Causa:</strong> API Key de Resend expirada o l√≠mite de env√≠os alcanzado.</p>
                    <p><strong>Soluci√≥n:</strong> Revisar logs en el dashboard de <strong>Resend</strong>. Verifica que
                        el remitente sea un dominio autorizado (`@pataamiga.mx`).</p>
                </div>
            </div>
        </section>

        <!-- PLAN DE QA -->
        <section id="qa">
            <h2>6. Plan de QA Maestro (Checklist Final)</h2>
            <div class="test-card">
                <table>
                    <thead>
                        <tr>
                            <th>Categor√≠a</th>
                            <th>Prueba</th>
                            <th>Resultado Cr√≠tico</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Embajadores</strong></td>
                            <td>Registro con archivos pesados (>5MB)</td>
                            <td>Debe fallar o avisar al usuario. No debe romper el backend.</td>
                        </tr>
                        <tr>
                            <td><strong>Finanzas</strong></td>
                            <td>Dos solicitudes de retiro simult√°neas (Race Condition)</td>
                            <td>La segunda debe fallar por saldo en 0. (Validado en API).</td>
                        </tr>
                        <tr>
                            <td><strong>Apelaciones</strong></td>
                            <td>Navegaci√≥n directa v√≠a URL a /admin?filter=appeals</td>
                            <td>Redirecci√≥n forzada si no es SuperAdmin.</td>
                        </tr>
                        <tr>
                            <td><strong>Seguridad</strong></td>
                            <td>Inyecci√≥n de scripts en el campo de Apelaci√≥n</td>
                            <td>Sanitizaci√≥n autom√°tica (Next.js/Supabase). No debe ejecutar JS.</td>
                        </tr>
                        <tr>
                            <td><strong>Visual</strong></td>
                            <td>Widget en modo m√≥vil (iPhone/Android)</td>
                            <td>Desplazamiento horizontal fluido y botones clickeables sin superposici√≥n.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- REFERENCIA API -->
        <section id="api">
            <h2>7. Referencia de API</h2>
            <p>Endpoints principales para integraciones de terceros o scripts de automatizaci√≥n.</p>

            <pre>// Obtener estado actual del embajador (Uso del Widget)
GET /api/ambassadors/me?memberstackId=MEM_ID

// Crear solicitud de retiro
POST /api/ambassadors/[id]/payouts

// Listar mascotas apeladas (Solo SuperAdmin)
GET /api/admin/pets/appealed

// Enviar respuesta de apelaci√≥n
POST /api/admin/members/[member_id]/appeal-response
{ "message": "...", "petId": "...", "adminId": "..." }</pre>
        </section>

    </main>

    <script>
        // Highlight active nav based on scroll
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('.nav-link');

            let current = "";
            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (pageYOffset >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href').includes(current)) {
                    link.classList.add('active');
                }
            });
        });
    </script>

</body>

</html>